---
title: "Stable Diffusionをスポットインスタンス×AWS Batchで動かす"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["aws","stablediffusion","awsbatch"]
published: false
---

## はじめに

[Stable Diffusion](https://github.com/CompVis/stable-diffusion)という、画像をAIが生成してくれる機能を利用できるツールがOSS化されたことが話題になっていました。
ここ最近MidJourneyというサービスが話題になっていましたが、同様のことが行えるツールがOSSとして公開されたことは大きなことだったことでしょう。

参考
https://zenn.dev/koyoarai_/articles/02f3ed864c6127bb2049

実のところ自分はそれほど興味がなかった[^1]のですが、[@ito_yusaku](https://twitter.com/ito_yusaku)さんの以下の記事を見て「あれ、これってスポットインスタンスの有効なユースケースそのままでは？」と思ったことがこの記事を書くモチベになりました。
https://qiita.com/ito-yusaku/items/c268afb502236a890f2a

しかも、「特定のコマンドを一時的にハイスペックな環境で実行する」というユースケースはAWS Batchを使うのにぴったりです。
普段からAWSに慣れ親しんでる方ならきっと共感していただけることでしょう。
ということで実際にやってみました。

先にスポットインスタンスとAWS Batchについて説明しますが、すでに知っている方は[構成](#構成)まで飛ばしてもらっても大丈夫です。

## スポットインスタンスとは

ここではEC2のスポットインスタンスの説明のみを記載します。
公式では下記のように説明されています。

> Amazon EC2 スポットインスタンスを使うと、AWS クラウド内の使用されていない EC2 キャパシティーを活用できます。
[Amazon EC2 スポットインスタンス](https://aws.amazon.com/jp/ec2/spot/)

EC2インスタンスを通常通り起動するとそれは**オンデマンドインスタンス**になります。
**スポットインスタンス**とは、とてもざっくり説明するとAWS側の余剰リソースを短時間だけ安価に利用するというEC2インスタンスの使い方です。

スポットインスタンスを使うには、スポットリクエストという形で支払ってもよい上限価格を指定します。かつては入札価格と呼ばれていました。
現在のスポットインスタンスの価格が上限価格を超えていなければスポットインスタンスを起動できます。
AWS側にスポットインスタンスとして使えるリソースがなくなったり、価格が上限価格を超えたりするとインスタンスが中断されます。
価格はEC2インスタンスのインスタンスタイプごと、かつAvailability Zoneごとに分かれています。
現在の価格や直近の価格推移はマネジメントコンソールやcliなどで確認できます。

うまく活用すればオンデマンドインスタンスよりも大きく安価にインスタンスを利用できますが、特性上長時間インスタンスを起動し続けることができません。
20220827現在、オプション指定によって最大6時間まで継続起動を保証できるのですが、基本的には途中で落ちても良いという前提で利用することになります。

スポットリクエストの種類など細かい説明はここでは省略します。

スポットインスタンスについては下記の資料がより詳しいです。
※SlideShareには閲覧制限があるためPDFの直リンクです
https://d1.awsstatic.com/webinars/jp/pdf/services/20190306_AWS-Blackbelt-EC2Spot.pdf

https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/using-spot-instances.html

## AWS Batchとは

もしかしたらあまり聞き慣れない方もいるかもしれませんが、AWSにはAWS Batchというサービスがあります。
[AWS Batch](https://aws.amazon.com/jp/batch/)

AWS Batchは裏でECSを使っています。
ECSのコンテナ環境を使ってジョブを定義し、任意の処理を実行させられます。
定義部分はECSのタスク定義に近いです。
ECSのコンテナ実行環境をバッチ処理や重い処理向けに利用できるサービス、と考えるとイメージがつきやすいかもしれません。
かつてはECS on EC2の環境しかなかったのですが、今はFargateも使用できます。
起動までのオーバーヘッドはあるものの、重めの処理や複数ジョブ間の連携が必要な処理を行う環境をAWSマネージドで定義できます。
（後述の記事に詳しいですが、Step Functionsを使ってもジョブ間連携のようなことが行えるため、このサービス特有のメリットというわけではありません）

Fargateが使えると言いましたが今回このサービスを出したのはECS on EC2の環境が使えるからです。
ECS on EC2の環境にはスポットインスタンスを選べます。
つまり、価格を抑えつつ高性能なインスタンスをバッチ処理に使用できるということです。

自分が説明するよりもはるかに詳しく書いてくれている記事があるのでリンクを貼っておきます。
https://dev.classmethod.jp/articles/relay_looking_back_aws-batch/

また、バッチ処理みたいなことは他にも行えるサービスがありますが、何をどのようにして行うかについては次の記事が詳しいです。

https://zenn.dev/faycute/articles/fb310e3ccd783f

## 構成

### スポットインスタンスを使用する

まずはスポットインスタンスを立ち上げる…前に、セットアップを行います。

元記事では以下のように料金について注意が記載されていました。

> この手順書ではAWSのp3.2xlargeというハイスペックタイプのインスタンスを使います。料金は東京リージョンのオンデマンドで4.194 USD/hour、執筆時点での円ドル相場が136.5円なので、1カ月間稼働させると41.2万円になります。1分あたりだと9.5円です。お財布にとって大変危険ですので、遊び終わったら必ずインスタンスのシャットダウンをするのを忘れないようにしてください。

しかし、セットアップを済ませたサーバを用意するだけであれば、いったんスペックの低いインスタンスでセットアップを済ませ、セットアップ済みのインスタンスのAMIを取得しておいて、あとから取得したAMIでハイスペックなインスタンスタイプで起動すれば十分です。
また、スポットインスタンスで毎度毎度セットアップをしてはおけないのでベースイメージを作っておくとよいでしょう。
（一応、スポットインスタンスの停止はインスタンスのstopかterminateかの挙動を選ぶオプションが存在します）

Stable Diffusionのサーバへのセットアップは[はじめに](#はじめに)のところで挙げた記事に従って行えばよいです。
環境構築する前に[Hugging Face](https://huggingface.co/)と[NVIDIA](https://developer.nvidia.com/login)の登録を済ませておいてください。
Hugging Faceの学習モデルのリポジトリにもあらかじめアクセスできるようにしておく必要があります。
https://huggingface.co/CompVis/stable-diffusion-v-1-4-original

また、注意事項としてP系のインスタンスタイプはデフォルトだとスポットインスタンスでの上限が0になっていて起動できません。
使う場合は先に上限緩和申請を済ませましょう。
上限緩和申請はAWSのService Quotas から行えるようになっています。
上限緩和申請を済ませるまでにはどうしてもラグがあります。
待てない場合は高いのを承知で普通のオンデマンドインスタンスでセットアップします。
実際に動かす環境ではないのでP系で最も小さい`p2.xlarge`でセットアップすれば多少はマシになりますが、それでも東京リージョンで$1.542/hなのでセットアップを終えたら停止や削除を忘れずに。

元記事ではNVIDIAのCuda toolkitのインストールでRHEL8版をインストールしていましたが、Amazon Linux2はRHEL7系なので以下で出てくる手順でyumを使ったほうが楽です。
というか、RHEL8版だとちゃんと動かない恐れがあるのでバージョンを合わせたほうが良いですね。

![AmazonLinux2へのcudaのインストール手順](/images/cuda_to_AmazonLinux2.png)

また、cuDNNのライブラリもrpmを使ってyum localinstallするだけで一発なので簡単です。
ただ、rpmをサーバー上にscpするなり、一度S3に上げてそこからEC2上に置くなりする必要があるのでその点にご注意ください。
下記画像のRedHat/Centos7.3〜のrpmを落とせばよいです。

![cuDNNのライブラリの取得元](/images/cuDNN_install_AmazonLinux2.png)

```bash
sudo yum -y localinstall cudnn-local-repo-rhel7-8.5.0.96-1.0-1.x86_64.rpm
```

※rpmは認証済みでないと落とせないのでサーバー上からリクエストを送って取得するのは諦めました。

余談ですがAmazon Linux2のサポート期限は2024年6月まで（もともと2023年6月までだったが延長された）なので、以後Amazon Linux2022などを使う場合はインストールパッケージが変わることになります。ご注意ください。

### AWS Batchで動かす

前述の上限緩和申請をあらかじめ済ませておいてください。
前述の通りAWS BatchはECSなので、Stable DiffusionをDocker化する必要があります。

[^1]: すごいことだとは思っていましたが、自分で試そうとまでは思っておらず…。
